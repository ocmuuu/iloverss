import { RSSArticle, RSSDataService } from '../model/RSSModel'
import webview from '@ohos.web.webview'
import resourceManager from '@ohos.resourceManager'
import { ImageCacheService } from '../service/ImageCacheService'
import { common } from '@kit.AbilityKit'
import PreferencesUtil from '../utils/PreferencesUtil'

// å…¼å®¹å¯èƒ½å­˜åœ¨ destroy() æ–¹æ³•çš„ WebViewController
interface WebviewDestroyable {
  destroy?: () => void
}

// ç”¨äºç±»å‹æ–­è¨€ä»¥å®‰å…¨è®¿é—® errorCode å±æ€§ï¼Œé¿å…ä½¿ç”¨å†…è”å¯¹è±¡ç±»å‹
interface ErrorCodeEvent {
  errorCode?: number
}

// æ‰©å±•çš„ WebView é”™è¯¯äº‹ä»¶
interface ExtendedWebErrorEvent extends ErrorCodeEvent {
  description?: string
  url?: string
  isForMainFrame?: boolean
}

// ä¾›æ—¥å¿—ä½¿ç”¨çš„é”™è¯¯è¯¦æƒ…
interface ErrorDetails {
  code?: number
  description?: string
  url?: string
  isMain?: boolean
}

// å£°æ˜å…¨å±€ getContext å‡½æ•°
declare function getContext(component?: object): common.UIAbilityContext

@Component
export default struct RSSArticleDetail {
  @Prop @Watch('onSelectedArticleChanged') selectedArticle: RSSArticle | undefined = undefined
  @State private webController: webview.WebviewController = new webview.WebviewController()
  @State private currentArticleId: string = '' // ç”¨äºè·Ÿè¸ªå½“å‰æ˜¾ç¤ºçš„æ–‡ç« ID
  @Link refreshTrigger: number // ç”¨äºé€šçŸ¥çˆ¶ç»„ä»¶åˆ·æ–°æ–‡ç« åˆ—è¡¨
  @State private isWebViewReady: boolean = false // WebViewæ˜¯å¦å·²å‡†å¤‡å°±ç»ª
  @State private isLoadingArticle: boolean = false // æ–‡ç« æ˜¯å¦æ­£åœ¨åŠ è½½ï¼Œç”¨äºæ˜¾ç¤ºå ä½å±‚
  // å·²ç§»é™¤ loadedArticleIdsã€memoryMonitor ä»¥åŠå®šæ—¶å›æ”¶ç›¸å…³å±æ€§

  // æ–°å¢ï¼šæ–‡ç« åˆ‡æ¢ç›¸å…³å±æ€§
  @Prop canGoPrevious: boolean = false // æ˜¯å¦å¯ä»¥åˆ‡æ¢åˆ°ä¸Šä¸€ç¯‡
  @Prop canGoNext: boolean = false // æ˜¯å¦å¯ä»¥åˆ‡æ¢åˆ°ä¸‹ä¸€ç¯‡
  onPreviousArticle?: () => void // åˆ‡æ¢åˆ°ä¸Šä¸€ç¯‡çš„å›è°ƒ
  onNextArticle?: () => void // åˆ‡æ¢åˆ°ä¸‹ä¸€ç¯‡çš„å›è°ƒ

  // æ–°å¢ï¼šåŠ è½½å¤±è´¥é‡è¯•æ§åˆ¶
  @State private loadRetryCount: number = 0 // å½“å‰é‡è¯•æ¬¡æ•°
  private readonly maxLoadRetries: number = 5 // æœ€å¤§é‡è¯•æ¬¡æ•°
  private readonly retryDelayMs: number = 2000 // é¦–æ¬¡é‡è¯•å»¶æ—¶ (ms)ï¼Œåç»­æŒ‰å€æ•°é€’å¢

  // å¾…åŠ è½½æ–‡ç« ï¼ˆä»…åœ¨é¦–æ¬¡ WebView æœªå°±ç»ªæ—¶ä½¿ç”¨ï¼‰
  @State private pendingArticle: RSSArticle | undefined = undefined

  /**
   * ç»„ä»¶å³å°†å‡ºç°æ—¶çš„ç”Ÿå‘½å‘¨æœŸ
   */
  aboutToAppear() {
    this.initializeArticle()
  }

  onPageShow() {
    this.initializeArticle()
  }

  /**
   * å½“selectedArticleå˜åŒ–æ—¶è§¦å‘ï¼ˆæ¢å¤Watchæœºåˆ¶ï¼‰
   */
  onSelectedArticleChanged() {
    console.info('RSSArticleDetail', `onSelectedArticleChanged ==> æ”¶åˆ°é€‰ä¸­æ–‡ç« å˜åŒ–, id: ${this.selectedArticle?.id}`)

    // ç›´æ¥åŠ è½½/åˆ‡æ¢æ–‡ç« å†…å®¹ï¼ˆä¸å†é”€æ¯ WebViewï¼‰

    // æ›´æ–°å½“å‰æ–‡ç« ID
    if (this.selectedArticle) {
      this.currentArticleId = this.selectedArticle.id
      console.info('RSSArticleDetail', `onSelectedArticleChanged ==> è®¾ç½® currentArticleId: ${this.currentArticleId}`)
    } else {
      this.currentArticleId = ''
      console.info('RSSArticleDetail', 'onSelectedArticleChanged ==> æœªé€‰ä¸­æ–‡ç« ')
    }

    // å¦‚æœ WebView å°šæœª readyï¼Œç¼“å­˜å¾…åŠ è½½æ–‡ç« ï¼›å¦åˆ™ç›´æ¥åŠ è½½
    if (!this.isWebViewReady) {
      this.pendingArticle = this.selectedArticle
    } else if (this.selectedArticle) {
      this.reloadWebContent()
    }
  }

  /**
   * åˆå§‹åŒ–æ–‡ç« æ˜¾ç¤º
   */
  private initializeArticle() {
    if (this.selectedArticle != undefined) {
      if (this.selectedArticle.id !== this.currentArticleId) {
        this.currentArticleId = this.selectedArticle.id
        this.reloadWebContent()
      }
    } else {
      this.currentArticleId = ''
    }
  }

  /**
   * é‡æ–°åŠ è½½Webå†…å®¹
   */
  private reloadWebContent() {
    console.info('RSSArticleDetail', `reloadWebContent ==> å¼€å§‹åŠ è½½æ–‡ç« , id: ${this.selectedArticle?.id}, WebView ready: ${this.isWebViewReady}`)
    if (!this.selectedArticle) {
      return
    }
    // WebView å°šæœª ready â€”â€” å…ˆç¼“å­˜
    if (!this.isWebViewReady) {
      this.pendingArticle = this.selectedArticle
      return
    }
    try {
      // å¼€å§‹åŠ è½½ï¼Œæ˜¾ç¤ºå ä½å±‚
      this.isLoadingArticle = true
      
      // é‡ç½®é‡è¯•è®¡æ•°
      this.loadRetryCount = 0
      
      const htmlContent = this.generateOptimizedArticleHTML(this.selectedArticle)
      const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(htmlContent)
      this.webController.loadUrl(dataUrl)
      
      // å¼‚æ­¥é¢„æŠ“å›¾ç‰‡å¹¶åœ¨ç¼“å­˜å®Œæˆåæ›¿æ¢ src
      this.prefetchImages(htmlContent)
      
      console.info('RSSArticleDetail', 'é‡æ–°åŠ è½½ Web å†…å®¹å®Œæˆ')
    } catch (error) {
      console.error('RSSArticleDetail', 'é‡æ–°åŠ è½½Webå†…å®¹å¤±è´¥:', JSON.stringify(error))
      // è‹¥åŠ è½½å¤±è´¥ï¼Œç«‹å³éšè—åŠ è½½å±‚
      this.isLoadingArticle = false
    }
  }

  /**
   * åˆ‡æ¢æ–‡ç« å·²è¯»çŠ¶æ€
   */
  private async toggleReadStatus() {
    if (!this.selectedArticle) return
    
    try {
      const newReadStatus = !this.selectedArticle.readStatus
      const success = await RSSDataService.markArticleAsRead(this.selectedArticle.id, newReadStatus)
      if (success) {
        const statusText = newReadStatus ? 'å·²è¯»' : 'æœªè¯»'
        console.info('RSSArticleDetail', `æ–‡ç«  ${this.selectedArticle.title} å·²æ ‡è®°ä¸º${statusText}`)
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        this.selectedArticle.readStatus = newReadStatus
        // è§¦å‘çˆ¶ç»„ä»¶åˆ·æ–°
        this.refreshTrigger++
      }
    } catch (error) {
      console.error('RSSArticleDetail', 'åˆ‡æ¢å·²è¯»çŠ¶æ€å¤±è´¥:', error)
    }
  }

  /**
   * åˆ‡æ¢æ”¶è—çŠ¶æ€
   */
  private async toggleStar() {
    if (!this.selectedArticle) return
    
    try {
      const success = await RSSDataService.toggleArticleStar(
        this.selectedArticle.id, 
        this.selectedArticle.starredStatus
      )
      if (success) {
        const newStatus = !this.selectedArticle.starredStatus
        console.info('RSSArticleDetail', `æ–‡ç«  ${this.selectedArticle.title} æ”¶è—çŠ¶æ€å˜æ›´ä¸º: ${newStatus}`)
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        this.selectedArticle.starredStatus = newStatus
        // è§¦å‘çˆ¶ç»„ä»¶åˆ·æ–°
        this.refreshTrigger++
      }
    } catch (error) {
      console.error('RSSArticleDetail', 'åˆ‡æ¢æ”¶è—çŠ¶æ€å¤±è´¥:', error)
    }
  }

  /**
   * ç”Ÿæˆä¼˜åŒ–çš„æ–‡ç« HTMLå†…å®¹ï¼ˆå‡å°‘å†…å­˜å ç”¨ï¼‰
   */
  private generateOptimizedArticleHTML(article: RSSArticle): string {
    // é™åˆ¶å†…å®¹é•¿åº¦ï¼Œé¿å…è¿‡é•¿çš„æ–‡ç« å ç”¨è¿‡å¤šå†…å­˜
    const maxContentLength = 10 * 1024 * 1024 // 10MBé™åˆ¶ï¼Œé€‚åˆå‡ ä¹æ‰€æœ‰æ–‡ç« 
    const content = article.content || article.summary || 'æš‚æ— å†…å®¹'
    const truncatedContent = content.length > maxContentLength
      ? `${content.substring(0, maxContentLength)}...<div style="padding:15px;background:#f0f8ff;border-left:4px solid #007AFF;margin:20px 0;border-radius:4px;"><p><strong>ğŸ“„ å†…å®¹è¿‡é•¿å·²æˆªæ–­</strong></p><p style="margin:5px 0;color:#666;font-size:14px;">æ–‡ç« å†…å®¹è¶…è¿‡10MBï¼Œå·²è‡ªåŠ¨æˆªæ–­ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚</p><p style="margin:5px 0;"><a href="${this.escapeHtml(article.link)}" target="_blank" style="color:#007AFF;text-decoration:none;">ğŸ‘† ç‚¹å‡»è¿™é‡Œé˜…è¯»å®Œæ•´åŸæ–‡</a></p></div>`
      : content
    
    return this.generateCompactHTML(article.title, article.author, article.publishDate, truncatedContent, article.link)
  }

  /**
   * ç®€å•çš„ HTML è½¬ä¹‰ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦ç ´åå±æ€§å­—ç¬¦ä¸²
   */
  private escapeHtml(text: string | undefined): string {
    if (!text) {
      return ''
    }
    return text
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/'/g, '&#39;')
  }

  /**
   * ç”Ÿæˆç´§å‡‘çš„HTMLæ¨¡æ¿ï¼ˆåŸç‰ˆæœ¬ï¼Œç”¨äºå®Œæ•´æ˜¾ç¤ºï¼‰
   */
  private generateArticleHTML(article: RSSArticle): string {
    const htmlTemplate = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${article.title}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #ffffff;
        }
        .article-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .article-title {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 15px 0;
            line-height: 1.3;
        }
        .article-meta {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .article-meta .separator {
            color: #ccc;
        }
        .article-content {
            font-size: 16px;
            line-height: 1.8;
            color: #333;
        }
        .article-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .article-content p {
            margin: 15px 0;
        }
        .article-content h1, .article-content h2, .article-content h3 {
            margin: 25px 0 15px 0;
            color: #1a1a1a;
        }
        .article-content h1 { font-size: 22px; }
        .article-content h2 { font-size: 20px; }
        .article-content h3 { font-size: 18px; }
        .article-content a {
            color: #007AFF;
            text-decoration: none;
        }
        .article-content a:hover {
            text-decoration: underline;
        }
        .article-content blockquote {
            border-left: 4px solid #007AFF;
            margin: 20px 0;
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-radius: 0 4px 4px 0;
        }
        .article-content code {
            background-color: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 14px;
        }
        .article-content pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .article-content pre code {
            background: none;
            padding: 0;
        }
        .article-content ul, .article-content ol {
            margin: 15px 0;
            padding-left: 25px;
        }
        .article-content li {
            margin: 8px 0;
        }
        .article-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }
        .read-original {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007AFF;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
        }
        .read-original:hover {
            background-color: #0056CC;
            text-decoration: none;
        }
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .article-title {
                font-size: 20px;
            }
            .article-content {
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="article-header">
        <h1 class="article-title">${article.title}</h1>
        <div class="article-meta">
            <span>${article.author || 'æœªçŸ¥ä½œè€…'}</span>
            <span class="separator">â€¢</span>
            <span>${article.publishDate}</span>
        </div>
    </div>
    <div class="article-content">
        ${article.content || article.summary || 'æš‚æ— å†…å®¹'}
    </div>
    <div class="article-footer">
        <a href="${article.link}" class="read-original" target="_blank">é˜…è¯»åŸæ–‡</a>
    </div>
</body>
</html>`
    return htmlTemplate
  }

  /**
   * ç”Ÿæˆç´§å‡‘çš„HTMLæ¨¡æ¿ï¼ˆå‡å°‘å†…å­˜å ç”¨ï¼‰
   */
  private generateCompactHTML(title: string, author: string, publishDate: string, content: string, link: string): string {
    return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC',sans-serif;line-height:1.6;color:#333;margin:0;padding:20px;background:#fff}
        .header{border-bottom:1px solid #eee;padding-bottom:20px;margin-bottom:20px}
        .title{font-size:24px;font-weight:600;color:#1a1a1a;margin:0 0 15px 0;line-height:1.3}
        .meta{font-size:14px;color:#666;display:flex;align-items:center;gap:12px}
        .content{font-size:16px;line-height:1.8}
        .content img{max-width:100%;height:auto;border-radius:8px;margin:15px 0}
        .content p{margin:15px 0}
        .content h1,.content h2,.content h3{margin:25px 0 15px 0;color:#1a1a1a}
        .content a{color:#007AFF;text-decoration:none}
        .footer{margin-top:40px;padding-top:20px;border-top:1px solid #eee;text-align:center}
        .read-original{display:inline-block;padding:10px 20px;background:#007AFF;color:white;text-decoration:none;border-radius:6px;font-size:14px}
        @media (max-width:768px){body{padding:15px}.title{font-size:20px}.content{font-size:15px}}
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">${title}</h1>
        <div class="meta">
            <span>${author || 'æœªçŸ¥ä½œè€…'}</span>
            <span>â€¢</span>
            <span>${publishDate}</span>
        </div>
    </div>
    <div class="content">${content}</div>
    <div class="footer">
        <a href="${link}" class="read-original" target="_blank">é˜…è¯»åŸæ–‡</a>
    </div>
</body>
</html>`
  }

  /**
   * æ‰“å¼€åŸæ–‡é“¾æ¥
   */
  private openOriginalArticle() {
    if (!this.selectedArticle || !this.selectedArticle.link) {
      console.warn('RSSArticleDetail', 'æ–‡ç« é“¾æ¥ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰“å¼€åŸæ–‡')
      return
    }
    
    try {
      const url = this.selectedArticle.link
      console.info('RSSArticleDetail', `æ‰“å¼€åŸæ–‡é“¾æ¥: ${url}`)
      
      // æš‚æ—¶åŠ è½½å¤–éƒ¨é“¾æ¥
      this.webController.loadUrl(url)
      
      // 10ç§’åè‡ªåŠ¨æ¢å¤åˆ°æ–‡ç« å†…å®¹ï¼ˆå»¶é•¿è¶…æ—¶ï¼‰
      setTimeout(() => {
        if (this.selectedArticle) {
          console.info('RSSArticleDetail', 'æ¢å¤æ–‡ç« å†…å®¹æ˜¾ç¤º')
          this.reloadWebContent()
        }
      }, 10000)
      
      console.info('RSSArticleDetail', 'åŸæ–‡é“¾æ¥å·²æ‰“å¼€ï¼Œ10ç§’åè‡ªåŠ¨æ¢å¤')
      
    } catch (error) {
      console.error('RSSArticleDetail', 'æ‰“å¼€åŸæ–‡å¤±è´¥:', error)
    }
  }

  /**
   * æ‰“å¼€å¸®åŠ©æ–‡æ¡£
   */
  private async openHelpDocument() {
    try {
      console.info('RSSArticleDetail', 'æ‰“å¼€å¸®åŠ©æ–‡æ¡£å¼€å§‹')
      
      // ç¡®ä¿WebViewå·²å‡†å¤‡å°±ç»ª
      if (!this.isWebViewReady) {
        console.warn('RSSArticleDetail', 'WebViewæœªå‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æ§åˆ¶å™¨é™„åŠ ')
        // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
        setTimeout(() => {
          if (this.isWebViewReady) {
            this.openHelpDocument()
          } else {
            console.error('RSSArticleDetail', 'WebViewæ§åˆ¶å™¨é™„åŠ è¶…æ—¶')
          }
        }, 1000)
        return
      }
      
      // ç›´æ¥ä½¿ç”¨rawfileåè®®åŠ è½½å¸®åŠ©æ–‡æ¡£
      const helpUrl = 'resource://rawfile/docs/help/index.html'
      
      console.info('RSSArticleDetail', `å¼€å§‹åŠ è½½å¸®åŠ©æ–‡æ¡£: ${helpUrl}`)
      
      // åœ¨WebViewä¸­åŠ è½½å¸®åŠ©æ–‡æ¡£
      this.webController.loadUrl(helpUrl)
      
      // æ¸…é™¤å½“å‰æ–‡ç« IDï¼Œè¡¨ç¤ºä¸å†æ˜¾ç¤ºæ–‡ç« å†…å®¹
      this.currentArticleId = 'help_document'
      
      console.info('RSSArticleDetail', 'å¸®åŠ©æ–‡æ¡£åŠ è½½å‘½ä»¤å·²å‘é€')
      
    } catch (error) {
      console.error('RSSArticleDetail', 'æ‰“å¼€å¸®åŠ©æ–‡æ¡£å¤±è´¥:', error)
    }
  }

  /**
   * è¿”å›åˆ°æ–‡ç« æ˜¾ç¤º
   */
  private returnToArticle() {
    try {
      console.info('RSSArticleDetail', 'ä»å¸®åŠ©æ–‡æ¡£è¿”å›åˆ°æ–‡ç« ')
      
      if (this.selectedArticle && this.isWebViewReady) {
        // é‡æ–°åŠ è½½å½“å‰æ–‡ç« 
        this.reloadWebContent()
        console.info('RSSArticleDetail', 'å·²è¿”å›åˆ°æ–‡ç« æ˜¾ç¤º')
      } else {
        // æ²¡æœ‰é€‰ä¸­æ–‡ç« ï¼Œæ¸…é™¤å½“å‰IDä»¥æ˜¾ç¤ºç©ºçŠ¶æ€
        this.currentArticleId = ''
        console.info('RSSArticleDetail', 'æ²¡æœ‰é€‰ä¸­æ–‡ç« ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€')
      }
      
    } catch (error) {
      console.error('RSSArticleDetail', 'è¿”å›æ–‡ç« å¤±è´¥:', error)
    }
  }

  /**
   * å›æ”¶ï¼ˆé”€æ¯å¹¶é‡æ–°åˆ›å»ºï¼‰WebView
   */
  private recycleWebView() {
    try {
      // ç›´æ¥é”€æ¯å¹¶é‡æ–°åˆ›å»º WebViewControllerï¼ˆä¸å†åŠ è½½ about:blankï¼Œé¿å…å¤±è”å¼‚å¸¸ï¼‰
      const destroyableController = this.webController as WebviewDestroyable
      if (typeof destroyableController.destroy === 'function') {
        // è‹¥ API æ”¯æŒ destroy åˆ™ä¼˜å…ˆè°ƒç”¨
        destroyableController.destroy()
      }

      this.webController = new webview.WebviewController()
      // æ–°åˆ›å»ºçš„ controller å°šæœª attach åˆ° Web ç»„ä»¶
      this.isWebViewReady = false

      console.info('RSSArticleDetail', 'WebView å·²å›æ”¶å¹¶é‡æ–°åˆ›å»º')

      // ç­‰å¾… onControllerAttached é‡ŒåŠ è½½
    } catch (error) {
      console.error('RSSArticleDetail', 'å›æ”¶ WebView å¤±è´¥:', error)
    }
  }

  /**
   * ç”Ÿæˆæç®€ç‰ˆæœ¬HTMLï¼šä»…ä¿ç•™çº¯æ–‡æœ¬ï¼Œå»é™¤å›¾ç‰‡ç­‰é‡èµ„æºï¼Œä¾›æœ€ç»ˆå…œåº•æ˜¾ç¤º
   */
  private generateFallbackHTML(article: RSSArticle): string {
    // æå–çº¯æ–‡æœ¬å¹¶æˆªæ–­è‡³ 50KB
    const source = article.content || article.summary || ''
    const textOnly = source.replace(/<[^>]+>/g, '').substring(0, 50 * 1024)
    const escaped = this.escapeHtml(textOnly)

    return `<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${this.escapeHtml(article.title)}</title><style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC',sans-serif;padding:16px;line-height:1.6;color:#333}</style></head><body><h2>${this.escapeHtml(article.title)}</h2><pre style="white-space:pre-wrap;word-break:break-all;font-size:14px">${escaped}</pre><p style="margin-top:24px"><a href="${this.escapeHtml(article.link)}" target="_blank" style="color:#007AFF;text-decoration:none">é˜…è¯»åŸæ–‡</a></p></body></html>`
  }

  /**
   * é¢„æŠ“å–æ–‡ç« ä¸­çš„å›¾ç‰‡å¹¶åœ¨ä¸‹è½½å®Œæˆåæ›¿æ¢ä¸ºæœ¬åœ°è·¯å¾„
   */
  private async prefetchImages(html: string) {
    // æ£€æŸ¥å›¾ç‰‡ç¼“å­˜æ˜¯å¦å¯ç”¨
    let imageCacheEnabled = false
    try {
      imageCacheEnabled = await PreferencesUtil.getImageCacheEnabled()
    } catch (error) {
      console.warn('RSSArticleDetail', 'è·å–å›¾ç‰‡ç¼“å­˜è®¾ç½®å¤±è´¥ï¼Œé»˜è®¤å…³é—­:', error)
      return
    }

    if (!imageCacheEnabled) {
      console.info('RSSArticleDetail', 'å›¾ç‰‡ç¼“å­˜å·²å…³é—­ï¼Œè·³è¿‡å›¾ç‰‡é¢„æŠ“å–')
      return
    }

    console.info('RSSArticleDetail', 'å›¾ç‰‡ç¼“å­˜å·²å¼€å¯ï¼Œå¼€å§‹é¢„æŠ“å–å›¾ç‰‡')

    const imgRegex = /<img[^>]+src=["']([^"']+)["']/gi
    let match: RegExpExecArray | null
    
    // è·å–åº”ç”¨ä¸Šä¸‹æ–‡
    let context: common.UIAbilityContext
    try {
      context = getContext(this) as common.UIAbilityContext
    } catch (error) {
      console.error('RSSArticleDetail', 'æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œè·³è¿‡å›¾ç‰‡ç¼“å­˜:', error)
      return
    }

    while ((match = imgRegex.exec(html)) !== null) {
      const url = match[1]
      // è·³è¿‡ data: url
      if (url.startsWith('data:')) {
        continue
      }
      try {
        const local = await ImageCacheService.downloadAndCache(url, this.selectedArticle?.id || 'unknown', context)
        if (local) {
          const escapedUrl = url.replace(/['"\\]/g, '\\$&')
          const escapedLocal = local.replace(/['"\\]/g, '\\$&')
          this.webController.runJavaScript(
            `document.querySelectorAll('img[src="${escapedUrl}"]').forEach(el=>{el.src='${escapedLocal}';})`
          )
          console.info('RSSArticleDetail', `å·²ä½¿ç”¨æœ¬åœ°ç¼“å­˜å›¾ç‰‡æ›¿æ¢: ${url} -> ${local}`)
        }
      } catch (e) {
        console.error('RSSArticleDetail', 'é¢„æŠ“å›¾ç‰‡å¤±è´¥:', e)
      }
    }
  }

  build() {
    Column() {
      // æ“ä½œæŒ‰é’®æ ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œæ²¡æœ‰é€‰ä¸­æ–‡ç« æ—¶ç¦ç”¨ï¼‰
      Row() {
        Blank()
        
        Row() {
          // ä¸Šä¸€ç¯‡æŒ‰é’®
          Image($r("app.media.up"))
            .width(20)
            .height(20)
            .margin({ right: 12 })
            .opacity(this.canGoPrevious ? 1.0 : 0.3)
            .onClick(() => {
              if (this.canGoPrevious && this.onPreviousArticle) {
                this.onPreviousArticle()
              }
            })
          
          // ä¸‹ä¸€ç¯‡æŒ‰é’®
          Image($r("app.media.down"))
            .width(20)
            .height(20)
            .margin({ right: 12 })
            .opacity(this.canGoNext ? 1.0 : 0.3)
            .onClick(() => {
              if (this.canGoNext && this.onNextArticle) {
                this.onNextArticle()
              }
            })
          
          // æ ‡è®°ä¸ºå·²è¯»/æœªè¯»æŒ‰é’®
          Image(this.selectedArticle?.readStatus ? $r("app.media.read") : $r("app.media.unread"))
            .width(20)
            .height(20)
            .margin({ right: 12 })
            .opacity(this.selectedArticle ? 1.0 : 0.3)

            .onClick(() => {
              if (this.selectedArticle) {
                this.toggleReadStatus()
              }
            })
          
          // æ”¶è—/å–æ¶ˆæ”¶è—æŒ‰é’®
          Image(this.selectedArticle?.starredStatus ? $r("app.media.star") : $r("app.media.unstar"))
            .width(20)
            .height(20)
            .margin({ right: 12 })
            .opacity(this.selectedArticle ? 1.0 : 0.3)

            .onClick(() => {
              if (this.selectedArticle) {
                this.toggleStar()
              }
            })
          
          // é˜…è¯»åŸæ–‡æŒ‰é’®
          Image($r("app.media.internet"))
            .width(20)
            .height(20)
            .margin({ right: 12 })
            .opacity(this.selectedArticle ? 1.0 : 0.3)

            .onClick(() => {
              if (this.selectedArticle) {
                this.openOriginalArticle()
              }
            })
          
          // å¸®åŠ©æ–‡æ¡£æŒ‰é’®ï¼ˆå§‹ç»ˆå¯ç”¨ï¼‰
          Image($r("app.media.information"))
            .width(20)
            .height(20)
            .opacity(1.0)
            .onClick(() => {
              console.info('RSSArticleDetail', 'å¸®åŠ©æŒ‰é’®è¢«ç‚¹å‡»')
              this.openHelpDocument()
            })
        }
      }
      .width("100%")
      .height(50)
      .padding({ left: 16, right: 16 })
      .backgroundColor("#f7f7f7")
      .border({ width: { bottom: 1 }, color: "#e0e0e0" })

      // å†…å®¹åŒºåŸŸ - ä½¿ç”¨Stackå¸ƒå±€ï¼ŒWebViewå§‹ç»ˆå­˜åœ¨
      Stack() {
        // Webç»„ä»¶å§‹ç»ˆå­˜åœ¨ï¼Œç”¨äºæ˜¾ç¤ºæ–‡ç« å†…å®¹æˆ–å¸®åŠ©æ–‡æ¡£
        Web({ 
          src: '',
          controller: this.webController 
        })
        .width("100%")
        .height("100%")
        .backgroundColor('#ffffff') // é¿å…åŠ è½½è¿‡ç¨‹ä¸­å‡ºç°é»‘åº•
        .onControllerAttached(() => {
          console.info('RSSArticleDetail', 'WebViewæ§åˆ¶å™¨å·²é™„åŠ ')
          this.isWebViewReady = true
          const articleToLoad = this.pendingArticle ?? this.selectedArticle
          this.pendingArticle = undefined
          console.info('RSSArticleDetail', `onControllerAttached ==> å¾…åŠ è½½æ–‡ç« : ${articleToLoad?.id}`)
          if (articleToLoad) {
            this.selectedArticle = articleToLoad   // åŒæ­¥çŠ¶æ€
            this.reloadWebContent()
          }
        })
        .onPageEnd(() => {
          console.info('RSSArticleDetail', 'é¡µé¢åŠ è½½å®Œæˆ')
          // éšè—åŠ è½½å±‚å¹¶é‡ç½®é‡è¯•è®¡æ•°
          this.isLoadingArticle = false
          this.loadRetryCount = 0
          // å¦‚æœå½“å‰æ­£åœ¨æ˜¾ç¤ºå¸®åŠ©æ–‡æ¡£ï¼Œä¸è¦è‡ªåŠ¨åˆ‡æ¢åˆ°æ–‡ç« 
          if (this.currentArticleId === 'help_document') {
            console.info('RSSArticleDetail', 'å½“å‰æ˜¾ç¤ºå¸®åŠ©æ–‡æ¡£ï¼Œä¿æŒä¸å˜')
            return
          }
          // å¦‚æœå½“å‰æœ‰é€‰ä¸­æ–‡ç« ä½†è¿˜æ²¡æœ‰åŠ è½½å†…å®¹ï¼Œç«‹å³åŠ è½½
          if (this.selectedArticle && this.currentArticleId !== this.selectedArticle.id) {
            console.info('RSSArticleDetail', 'æ£€æµ‹åˆ°æ–°æ–‡ç« ï¼Œç«‹å³åŠ è½½å†…å®¹')
            this.reloadWebContent()
          }
          // æ›´æ–°å½“å‰æ–‡ç« ID
          if (this.selectedArticle) {
            this.currentArticleId = this.selectedArticle.id
          }
        })
        .onErrorReceive((event) => {
          const extEvent = event as ExtendedWebErrorEvent
          const errorDetails: ErrorDetails = {
            code: extEvent.errorCode,
            description: extEvent.description,
            url: extEvent.url,
            isMain: extEvent.isForMainFrame
          }
          console.error('RSSArticleDetail', 'æ–‡ç« å†…å®¹åŠ è½½å¤±è´¥:', JSON.stringify(errorDetails))
          this.isLoadingArticle = false

          // è¯¦ç»†å­—æ®µæ—¥å¿—
          console.info('RSSArticleDetail', `OnErrorReceiveEvent description: ${extEvent.description || 'N/A'}, url: ${extEvent.url || 'N/A'}, isMain: ${extEvent.isForMainFrame}`)

          // è‹¥æ£€æµ‹åˆ° WebView çŠ¶æ€å¼‚å¸¸ï¼ˆå¦‚å´©æºƒã€æ¸²æŸ“è¿›ç¨‹ä¸¢å¤±ç­‰ï¼‰ï¼Œå°è¯•è‡ªåŠ¨å›æ”¶å¹¶é‡æ–°åŠ è½½
          const errorCode = extEvent.errorCode ?? -1
          // OpenHarmony ç›®å‰ errorCode == -1 æ—¶å¤šä¸ºæœªçŸ¥é”™è¯¯ï¼Œç›´æ¥è‡ªæ„ˆå¤„ç†
          console.warn('RSSArticleDetail', `æ£€æµ‹åˆ° WebView é”™è¯¯ç : ${errorCode}ï¼Œå¯åŠ¨è‡ªæ„ˆæµç¨‹`)
          try {
            if (this.loadRetryCount < this.maxLoadRetries) {
              this.loadRetryCount++
              const delay = this.retryDelayMs * this.loadRetryCount
              console.warn('RSSArticleDetail', `å°†åœ¨ ${delay}ms åå°è¯•ç¬¬ ${this.loadRetryCount} æ¬¡é‡è¯•`)

              // å›æ”¶å¹¶ç­‰å¾…
              this.recycleWebView()

              setTimeout(() => {
                if (this.selectedArticle) {
                  console.info('RSSArticleDetail', 'é‡è¯•åŠ è½½æ–‡ç« å†…å®¹')
                  this.reloadWebContent()
                }
              }, delay)
            } else {
              console.error('RSSArticleDetail', 'å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢è‡ªåŠ¨é‡è¯•ï¼Œå°è¯•åŠ è½½ç®€åŒ–ç‰ˆæœ¬')

              if (this.selectedArticle) {
                const fallbackHtml = this.generateFallbackHTML(this.selectedArticle)
                try {
                  this.webController.loadUrl('data:text/html;charset=utf-8,' + encodeURIComponent(fallbackHtml))
                  this.isLoadingArticle = false
                  console.info('RSSArticleDetail', 'å·²åŠ è½½ç®€åŒ–ç‰ˆæœ¬æ–‡ç« å†…å®¹')
                } catch (fallbackErr) {
                  console.error('RSSArticleDetail', 'åŠ è½½ç®€åŒ–ç‰ˆæœ¬ä»å¤±è´¥:', fallbackErr)
                }
              }
            }
          } catch (e) {
            console.error('RSSArticleDetail', 'è‡ªæ„ˆæµç¨‹å¤±è´¥:', e)
          }
        })
        .javaScriptAccess(true)
        .domStorageAccess(true)
        .imageAccess(true)
        .mixedMode(MixedMode.All)
        .zoomAccess(true)
        .overviewModeAccess(true)
        .databaseAccess(true)
        
        // ç©ºçŠ¶æ€æç¤ºï¼ˆåªåœ¨æ²¡æœ‰é€‰ä¸­æ–‡ç« ä¸”æ²¡æœ‰åŠ è½½å¸®åŠ©æ–‡æ¡£æ—¶æ˜¾ç¤ºï¼‰
        if (!this.selectedArticle && this.currentArticleId !== 'help_document') {
          Column() {
            Image($r("app.media.rss"))
              .width(80)
              .height(80)
              .opacity(0.3)
              .margin({ bottom: 16 })
            
            Text("é€‰æ‹©ä¸€ç¯‡æ–‡ç« å¼€å§‹é˜…è¯»")
              .fontSize(16)
              .fontColor("#999999")
              
            Text("ä»å·¦ä¾§æ–‡ç« åˆ—è¡¨ä¸­é€‰æ‹©æ„Ÿå…´è¶£çš„å†…å®¹")
              .fontSize(14)
              .fontColor("#cccccc")
              .margin({ top: 8 })
          }
          .width("100%")
          .height("100%")
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor("#ffffff")
        }
        
        // åŠ è½½ä¸­çš„åŠé€æ˜é®ç½©å±‚
        if (this.isLoadingArticle) {
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#007AFF')
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('rgba(255,255,255,0.6)')
        }
      }
      .layoutWeight(1)
    }
    .width("100%")
    .height("100%")
    .backgroundColor("#f5f5f5")
  }
} 
import { RSSArticle, RSSDataService } from '../model/RSSModel'
import { ArticleDAO } from '../model/ArticleDAO'
import webview from '@ohos.web.webview'
import resourceManager from '@ohos.resourceManager'
import { ImageCacheService } from '../service/ImageCacheService'
import { common } from '@kit.AbilityKit'
import PreferencesUtil from '../utils/PreferencesUtil'
import { GlobalState } from '../model/GlobalState'
import fs from '@ohos.file.fs'

// è¿è¡Œæ—¶æ£€æµ‹ createUri æ–¹æ³•ï¼Œé¿å…ç±»å‹å£°æ˜å†²çª
interface ErrorCodeEvent {
  errorCode?: number
}

interface ExtendedWebErrorEvent extends ErrorCodeEvent {
  description?: string
  url?: string
  isForMainFrame?: boolean
}

interface ErrorDetails {
  code?: number
  description?: string
  url?: string
  isMain?: boolean
}

declare function getContext(component?: ESObject): common.UIAbilityContext

@Component
export default struct RSSArticleDetail {
  @Prop @Watch('onSelectedArticleChanged') selectedArticle: RSSArticle | undefined = undefined
  @State private webController: webview.WebviewController = new webview.WebviewController()
  @State private currentArticleId: string = ''
  @Link refreshTrigger: number
  @State private isWebViewReady: boolean = false
  @State private isLoadingArticle: boolean = false
  @State private showHelp: boolean = false

  @Prop canGoPrevious: boolean = false
  @Prop canGoNext: boolean = false

  @State private loadRetryCount: number = 0
  private readonly maxLoadRetries: number = 5
  private readonly retryDelayMs: number = 2000

  @State private pendingArticle: RSSArticle | undefined = undefined

  @StorageLink('selectedArticleId') selectedArticleId: string = ''
  @StorageLink('currentArticleIndex') @Watch('onGlobalIndexChanged') currentIndex: number = -1
  @StorageLink('articleListTotal') totalArticles: number = 0
  @StorageLink('keyboardNavigationEnabled') keyboardEnabled: boolean = true
  @StorageLink('refreshTrigger') @Watch('onGlobalRefreshTriggered') globalRefreshTrigger: number = 0
  @StorageLink('showKeyboardHints') showKeyboardHints: boolean = true

  aboutToAppear() {
    this.initializeArticle()
    setTimeout(() => {
      // å¯ä»¥åœ¨è¿™é‡Œè¯·æ±‚ç„¦ç‚¹ï¼Œä½†é€šå¸¸ç‚¹å‡»ç»„ä»¶åŒºåŸŸåå°±ä¼šè·å¾—ç„¦ç‚¹
    }, 100)
  }

  onPageShow() {
    this.initializeArticle()
  }

  onGlobalIndexChanged() {
    // è¿™é‡Œå¯ä»¥é€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°é€‰ä¸­æ–‡ç« 
    // å…·ä½“å®ç°å–å†³äºä¸çˆ¶ç»„ä»¶çš„é€šä¿¡æ–¹å¼
  }

  onGlobalRefreshTriggered() {
    // è§¦å‘æœ¬åœ°åˆ·æ–°ï¼Œä¿æŒä¸åŸæœ‰æœºåˆ¶çš„å…¼å®¹æ€§
    this.refreshTrigger++
  }

  onSelectedArticleChanged() {
    if (this.selectedArticle) {
      this.currentArticleId = this.selectedArticle.id
    } else {
      this.currentArticleId = ''
    }

    if (!this.isWebViewReady) {
      this.pendingArticle = this.selectedArticle
    } else if (this.selectedArticle) {
      this.reloadWebContent()
    }
  }

  private initializeArticle() {
    if (this.selectedArticle != undefined) {
      if (this.selectedArticle.id !== this.currentArticleId) {
        this.currentArticleId = this.selectedArticle.id
        this.reloadWebContent()
      }
    } else {
      this.currentArticleId = ''
    }
  }

  private async reloadWebContent() {
    if (!this.selectedArticle) {
      return
    }
    if (!this.isWebViewReady) {
      this.pendingArticle = this.selectedArticle
      return
    }
    try {
      this.isLoadingArticle = true
      // æœ€å¤šæ˜¾ç¤ºåŠ è½½è’™ç‰ˆ 3 ç§’ï¼Œè¶…æ—¶è‡ªåŠ¨éšè—
      setTimeout(() => {
        if (this.isLoadingArticle) {
          this.isLoadingArticle = false
        }
      }, 3000)
      this.showHelp = false
      
      const baseHtml = this.generateOptimizedArticleHTML(this.selectedArticle)
      // å°†å·²ç¼“å­˜å›¾ç‰‡æ›¿æ¢ä¸ºå—ä¿¡ä»» ability:// URI
      const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(baseHtml)
      this.webController.loadUrl(dataUrl)
      
      this.prefetchImages(baseHtml)
      
    } catch (error) {
      console.error('RSSArticleDetail', 'é‡æ–°åŠ è½½Webå†…å®¹å¤±è´¥:', JSON.stringify(error))
      this.isLoadingArticle = false
    }
  }

  /**
   * ä»…æ£€æŸ¥ <img> æ˜¯å¦å·²æœ‰æœ¬åœ°ç¼“å­˜å¹¶è¾“å‡ºæ—¥å¿—ï¼›
   * å¦‚æœªå‘½ä¸­ä¸”ç”¨æˆ·å¼€å¯ç¼“å­˜ï¼Œåˆ™åå°ä¸‹è½½ï¼ˆä¸é˜»å¡ï¼‰ã€‚
   */
  private async checkImagesCache(html: string, articleId: string): Promise<void> {
    try {
      const context = getContext(this) as common.UIAbilityContext
      if (!context) {
        return
      }

      let imageCacheEnabled: boolean = false
      try {
        imageCacheEnabled = await PreferencesUtil.getImageCacheEnabled()
      } catch (_) {
        imageCacheEnabled = false
      }

      const imgRegex = /<img[^>]+src=["']([^"']+)["'][^>]*>/gi
      let match: RegExpExecArray | null

      while ((match = imgRegex.exec(html)) !== null) {
        const url = match[1]
        if (url.startsWith('data:')) {
          continue
        }

        try {
          const cachedPath = await ImageCacheService.getCachedPath(url, articleId, context)
          if (cachedPath) {
            // console.info('ImageCacheService', `âœ… å·²ä½¿ç”¨ç¼“å­˜æ–‡ä»¶ - URL: ${url}`)
          } else if (imageCacheEnabled) {
            // åå°ä¸‹è½½ï¼Œä¸é˜»å¡é¡µé¢åŠ è½½
            ImageCacheService.downloadAndCache(url, articleId, context).catch(() => {})
          }
        } catch {
          // å¿½ç•¥å•ä¸ªå›¾ç‰‡é”™è¯¯
        }
      }
    } catch (_) {
      // å¿½ç•¥é”™è¯¯ï¼Œé¿å…å½±å“é¡µé¢åŠ è½½
    }
  }

  /**
   * å°†å·²ç¼“å­˜å›¾ç‰‡æ›¿æ¢ä¸º data:image/...;base64,xxxx
   */
  private async replaceImagesWithBase64Cached(html: string, articleId: string): Promise<string> {
    try {
      const context = getContext(this) as common.UIAbilityContext
      if (!context) {
        return html
      }

      let imageCacheEnabled: boolean = false
      try {
        imageCacheEnabled = await PreferencesUtil.getImageCacheEnabled()
      } catch (_) {
        imageCacheEnabled = false
      }

      const imgRegex = /<img[^>]+src=["']([^"']+)["'][^>]*>/gi
      let resultHtml = html
      let match: RegExpExecArray | null

      const asyncTasks: Promise<void>[] = []

      while ((match = imgRegex.exec(html)) !== null) {
        const url = match[1]
        if (url.startsWith('data:')) {
          continue
        }

        try {
          const cachedPath = await ImageCacheService.getCachedPath(url, articleId, context)
          if (cachedPath) {
            const base64 = await this.readFileToBase64(cachedPath)
            if (base64) {
              const mime = this.detectMimeFromExtension(url)
              const dataUri = `data:${mime};base64,${base64}`
              resultHtml = resultHtml.replace(url, dataUri)
              // console.info('ImageCacheService', `ğŸ–¼ï¸ ä½¿ç”¨ Base64 ç¼“å­˜ - URL: ${url}`)
            }
          } else if (imageCacheEnabled) {
            asyncTasks.push((async () => { await ImageCacheService.downloadAndCache(url, articleId, context); })())
          }
        } catch {
          // å¿½ç•¥å•ä¸ªå›¾ç‰‡é”™è¯¯
        }
      }

      if (asyncTasks.length > 0) {
        Promise.all(asyncTasks).then(() => {})
      }

      return resultHtml
    } catch {
      return html
    }
  }

  /** æŠŠæ–‡ä»¶è¯»å–ä¸º Base64 å­—ç¬¦ä¸² */
  private async readFileToBase64(filePath: string): Promise<string | null> {
    try {
      const file = await fs.open(filePath, fs.OpenMode.READ_ONLY)
      const stat = await fs.stat(filePath)
      const buffer = new ArrayBuffer(stat.size)
      await fs.read(file.fd, buffer)
      await fs.close(file.fd)
      return this.arrayBufferToBase64(buffer)
    } catch {
      return null
    }
  }

  private arrayBufferToBase64(buffer: ArrayBuffer): string {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='
    const bytes = new Uint8Array(buffer)
    let result = ''
    let i = 0
    for (; i + 2 < bytes.length; i += 3) {
      const triple = (bytes[i] << 16) | (bytes[i + 1] << 8) | bytes[i + 2]
      result += chars.charAt((triple >> 18) & 0x3f)
      result += chars.charAt((triple >> 12) & 0x3f)
      result += chars.charAt((triple >> 6) & 0x3f)
      result += chars.charAt(triple & 0x3f)
    }
    if (i < bytes.length) {
      const byte1 = bytes[i]
      const byte2 = i + 1 < bytes.length ? bytes[i + 1] : 0
      const pad = i + 1 < bytes.length ? 1 : 2
      const triple = (byte1 << 16) | (byte2 << 8)
      result += chars.charAt((triple >> 18) & 0x3f)
      result += chars.charAt((triple >> 12) & 0x3f)
      result += pad === 2 ? '=' : chars.charAt((triple >> 6) & 0x3f)
      result += '='
    }
    return result
  }

  private detectMimeFromExtension(url: string): string {
    const lower = url.toLowerCase()
    if (lower.endsWith('.png')) return 'image/png'
    if (lower.endsWith('.jpg') || lower.endsWith('.jpeg')) return 'image/jpeg'
    if (lower.endsWith('.gif')) return 'image/gif'
    if (lower.endsWith('.webp')) return 'image/webp'
    if (lower.endsWith('.bmp')) return 'image/bmp'
    return 'image/*'
  }

  private handleKeyboardEvent(event: KeyEvent): boolean {
    if (!this.keyboardEnabled || !this.selectedArticle) {
      return false
    }

    if (event.type === KeyType.Down) {
      if (event.keyCode === 2063) { // Mé”®
        this.toggleReadStatus()
        return true
      }
      
      if (event.keyCode === 2067) { // Sé”®
        this.toggleStar()
        return true
      }
      
      if (event.keyCode === 2049 || event.keyCode === 2022) { // Jé”®æˆ–å³ç®­å¤´
        GlobalState.switchToNextArticle()
        return true
      }
      
      if (event.keyCode === 2048 || event.keyCode === 2021) { // Ké”®æˆ–å·¦ç®­å¤´
        GlobalState.switchToPreviousArticle()
        return true
      }
    }
    
    return false
  }

  private async toggleReadStatus() {
    if (!this.selectedArticle) return
    
    try {
      const success = await GlobalState.updateArticleReadStatus(this.selectedArticle.id, !this.selectedArticle.readStatus)
      
      if (success) {
        this.selectedArticle.readStatus = !this.selectedArticle.readStatus
        this.refreshTrigger++
      }
    } catch (error) {
      console.error('RSSArticleDetail', 'åˆ‡æ¢å·²è¯»çŠ¶æ€å¤±è´¥:', error)
    }
  }

  private async toggleStar() {
    if (!this.selectedArticle) return
    
    try {
      const success = await GlobalState.updateArticleStarStatus(this.selectedArticle.id, this.selectedArticle.starredStatus)
      
      if (success) {
        this.selectedArticle.starredStatus = !this.selectedArticle.starredStatus
        this.refreshTrigger++
      }
    } catch (error) {
      console.error('RSSArticleDetail', 'åˆ‡æ¢æ”¶è—çŠ¶æ€å¤±è´¥:', error)
    }
  }

  private generateOptimizedArticleHTML(article: RSSArticle): string {
    return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: system-ui; margin: 16px; line-height: 1.6; color: #333; }
        h1 { font-size: 24px; margin: 0 0 16px 0; }
        .meta { color: #666; font-size: 14px; margin-bottom: 16px; }
        .content { font-size: 16px; }
        img { max-width: 100%; height: auto; margin: 8px 0; }
        a { color: #007AFF; }
        pre { background: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>${article.title}</h1>
    <div class="meta">${article.publishDate} | ${article.author || 'æœªçŸ¥ä½œè€…'}</div>
    <div class="content">${article.content || article.summary || 'æ— å†…å®¹'}</div>
</body>
</html>`
  }

  private async prefetchImages(htmlContent: string) {
    try {
      // ä»…å½“ç”¨æˆ·å¼€å¯â€œå›¾ç‰‡ç¼“å­˜â€åŠŸèƒ½æ—¶æ‰ä¸»åŠ¨ä¸‹è½½ä¸‹ä¸€ç¯‡æ–‡ç« çš„å›¾ç‰‡
      let imageCacheEnabled: boolean = false
      try {
        imageCacheEnabled = await PreferencesUtil.getImageCacheEnabled()
      } catch (_) {
        imageCacheEnabled = false
      }
      if (!imageCacheEnabled) {
        return
      }

      const context = getContext(this) as common.UIAbilityContext
      if (!context) {
        return
      }

      const nextArticle = GlobalState.getNextArticle()
      if (!nextArticle) {
        return
      }

      const nextArticleImages: string[] = []
      try {
        const fullArticle = await ArticleDAO.getArticleByID(nextArticle.id)
        
        if (fullArticle && (fullArticle.contentText || fullArticle.summary)) {
          const nextArticleContent = fullArticle.contentText || fullArticle.summary || ''
          const imgRegex = /<img[^>]+src=["']([^"']+)["']/gi
          let match: RegExpExecArray | null

          while ((match = imgRegex.exec(nextArticleContent)) !== null) {
            const url = match[1]
            if (url.startsWith('data:')) {
              continue
            }
            nextArticleImages.push(url)
          }
        }
      } catch (error) {
        return
      }

      if (nextArticleImages.length === 0) {
        return
      }

      setTimeout(async () => {
        for (const url of nextArticleImages) {
          try {
            await ImageCacheService.downloadAndCache(url, nextArticle.id, context)
          } catch (e) {
            // ä¸‹ä¸€ç¯‡æ–‡ç« å›¾ç‰‡é¢„ç¼“å­˜å¤±è´¥
          }
        }
      }, 500)

    } catch (error) {
      // é¢„ç¼“å­˜ä¸‹ä¸€ç¯‡æ–‡ç« å›¾ç‰‡å¤±è´¥
    }
  }

  private openOriginalArticle() {
    if (!this.selectedArticle || !this.selectedArticle.link) {
      return
    }
    
    try {
      const url = this.selectedArticle.link
      this.webController.loadUrl(url)
      
      setTimeout(() => {
        if (this.selectedArticle) {
          this.reloadWebContent()
        }
      }, 10000)
      
    } catch (error) {
      console.error('RSSArticleDetail', 'æ‰“å¼€åŸæ–‡å¤±è´¥:', error)
    }
  }

  private async openHelpDocument() {
    try {
      if (!this.isWebViewReady) {
        setTimeout(() => {
          if (this.isWebViewReady) {
            this.openHelpDocument()
          }
        }, 1000)
        return
      }
      
      this.showHelp = true
      const helpUrl = 'resource://rawfile/docs/about/index.html'
      this.webController.loadUrl(helpUrl)
      this.currentArticleId = 'help_document'
      
    } catch (error) {
      console.error('RSSArticleDetail', 'æ‰“å¼€å¸®åŠ©æ–‡æ¡£å¤±è´¥:', error)
    }
  }

  // generateFallbackHTML æ–¹æ³•å·²ç§»é™¤ï¼Œç®€åŒ– HTML å›é€€åŠŸèƒ½å–æ¶ˆã€‚

  build() {
    Column() {
      Row() {
        Blank()
        
        Row() {
          Image($r("app.media.up"))
            .width(20)
            .height(20)
            .margin({ right: 12 })
            .opacity(GlobalState.canGoPrevious() ? 1.0 : 0.3)
            .onClick(() => {
              GlobalState.switchToPreviousArticle()
            })
          
          Image($r("app.media.down"))
            .width(20)
            .height(20)
            .margin({ right: 12 })
            .opacity(GlobalState.canGoNext() ? 1.0 : 0.3)
            .onClick(() => {
              GlobalState.switchToNextArticle()
            })
          
          Image(this.selectedArticle?.readStatus ? $r("app.media.read") : $r("app.media.unread"))
            .width(20)
            .height(20)
            .margin({ right: 12 })
            .opacity(this.selectedArticle ? 1.0 : 0.3)
            .onClick(() => {
              if (this.selectedArticle) {
                this.toggleReadStatus()
              }
            })
          
          Image(this.selectedArticle?.starredStatus ? $r("app.media.star") : $r("app.media.unstar"))
            .width(20)
            .height(20)
            .margin({ right: 12 })
            .opacity(this.selectedArticle ? 1.0 : 0.3)
            .onClick(() => {
              if (this.selectedArticle) {
                this.toggleStar()
              }
            })
          
          Image($r("app.media.internet"))
            .width(20)
            .height(20)
            .margin({ right: 12 })
            .opacity(this.selectedArticle ? 1.0 : 0.3)
            .onClick(() => {
              if (this.selectedArticle) {
                this.openOriginalArticle()
              }
            })
          
          Image($r("app.media.information"))
            .width(20)
            .height(20)
            .opacity(1.0)
            .onClick(() => {
              this.openHelpDocument()
            })
        }
      }
      .width("100%")
      .height(50)
      .padding({ left: 16, right: 16 })
      .backgroundColor("#f7f7f7")
      .border({ width: { bottom: 1 }, color: "#e0e0e0" })

      Stack() {
        Web({ 
          src: '',
          controller: this.webController 
        })
        .focusable(false)
        .width("100%")
        .height("100%")
        .backgroundColor('#ffffff')
        .onControllerAttached(() => {
          this.isWebViewReady = true
          const articleToLoad = this.pendingArticle ?? this.selectedArticle
          this.pendingArticle = undefined
          if (articleToLoad) {
            this.selectedArticle = articleToLoad
            this.reloadWebContent()
          }
        })
        .onPageEnd(() => {
          this.isLoadingArticle = false
          // ä¸åœ¨ onPageEnd é‡ç½® loadRetryCountï¼Œé¿å…ä¸»æ¡†æ¶åŠ è½½é”™è¯¯å¯¼è‡´æ— é™é‡è¯•å¾ªç¯
          if (this.currentArticleId === 'help_document') {
            return
          }
          if (this.selectedArticle && this.currentArticleId !== this.selectedArticle.id) {
            this.reloadWebContent()
          }
          if (this.selectedArticle) {
            this.currentArticleId = this.selectedArticle.id
          }
        })
        .onErrorReceive((event: ESObject) => {
          const extEvent = event as ExtendedWebErrorEvent
          // ä»…å½“ç¡®è®¤æ˜¯ä¸»æ¡†æ¶å¤±è´¥ (isForMainFrame === true) ä¸” errorCode != -1 æ—¶æ‰é‡è¯•ï¼›
          // å¦åˆ™è®¤ä¸ºæ˜¯å­èµ„æºæˆ–éè‡´å‘½é”™è¯¯ï¼Œå¿½ç•¥ä»¥é¿å…é‡å¤åˆ·æ–°ã€‚
          if (extEvent.isForMainFrame !== true) {
            return
          }
          const errorDetails: ErrorDetails = {
            code: extEvent.errorCode,
            description: extEvent.description,
            url: extEvent.url,
            isMain: extEvent.isForMainFrame
          }
          
          this.isLoadingArticle = false
          
          const errorCode = extEvent.errorCode ?? -1
          
          if (errorCode === -3 || errorCode === -1) {
            return
          }
          
          console.error('RSSArticleDetail', `æ–‡ç« å†…å®¹åŠ è½½å¤±è´¥: é”™è¯¯ç =${errorCode}, æè¿°=${extEvent.description || 'N/A'}, URL=${extEvent.url || 'N/A'}, ä¸»æ¡†æ¶=${extEvent.isForMainFrame}`)
          
          // ä¸å†è‡ªåŠ¨é‡è¯•ï¼Œä¹Ÿä¸é™çº§ç®€åŒ– HTMLï¼Œä»…è®°å½•é”™è¯¯ã€‚
          return
        })

        if (this.selectedArticle && this.isLoadingArticle) {
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#007AFF')
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('rgba(255, 255, 255, 0.8)')
        }

        if (!this.selectedArticle && !this.showHelp) {
          Column() {
            Image($r("app.media.rss"))
              .width(60)
              .height(60)
              .opacity(0.3)
              .margin({ bottom: 12 })
            
            Text('é€‰æ‹©ä¸€ç¯‡æ–‡ç« æŸ¥çœ‹è¯¦æƒ…')
              .fontSize(16)
              .fontColor('#999999')
              
            Text('æˆ–ç‚¹å‡»ä¸Šæ–¹å¸®åŠ©æŒ‰é’®æŸ¥çœ‹ä½¿ç”¨è¯´æ˜')
              .fontSize(12)
              .fontColor('#bbb')
              .margin({ top: 4 })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
      }
      .layoutWeight(1)
    }
    .width("100%")
    .height("100%")
    .backgroundColor("#f5f5f5")
    .focusable(true)
    .onKeyEvent((event: KeyEvent): boolean => {
      return this.handleKeyboardEvent(event)
    })
  }
} 
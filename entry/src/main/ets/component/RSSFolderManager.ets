import { RSSFolder, RSSFeed, RSSDataService } from '../model/RSSModel'
import FolderDAO from '../model/FolderDAO'
import { Toast } from '../utils/Toast'

@Component
export struct RSSFolderManager {
  @State folders: RSSFolder[] = []
  @State selectedFolderId: string | null = null
  @State feedsInFolder: RSSFeed[] = []
  @State showCreateDialog: boolean = false
  @State newFolderName: string = ''
  @State newFolderDescription: string = ''
  @State newFolderColor: string = '#1890ff'

  async aboutToAppear() {
    await this.loadFolders()
  }

  /**
   * åŠ è½½æ‰€æœ‰æ–‡ä»¶å¤¹
   */
  async loadFolders() {
    try {
      this.folders = await RSSDataService.getAllFolders()
    } catch (error) {
      Toast.show('åŠ è½½æ–‡ä»¶å¤¹å¤±è´¥')
    }
  }

  /**
   * åŠ è½½æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„è®¢é˜…æº
   */
  async loadFeedsInFolder(folderId: string | null) {
    try {
      this.feedsInFolder = await RSSDataService.getFeedsByFolderId(folderId)
      this.selectedFolderId = folderId
    } catch (error) {
      Toast.show('åŠ è½½æ–‡ä»¶å¤¹å†…å®¹å¤±è´¥')
    }
  }

  /**
   * åˆ›å»ºæ–°æ–‡ä»¶å¤¹
   */
  async createFolder() {
    if (!this.newFolderName.trim()) {
      Toast.show('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°')
      return
    }

    try {
      const success = await RSSDataService.createFolder(
        this.newFolderName.trim(),
        this.newFolderDescription.trim(),
        this.newFolderColor
      )
      
      if (success) {
        Toast.show('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ')
        this.showCreateDialog = false
        this.newFolderName = ''
        this.newFolderDescription = ''
        this.newFolderColor = '#1890ff'
        await this.loadFolders()
      } else {
        Toast.show('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥')
      }
    } catch (error) {
      Toast.show('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥')
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('æ–‡ä»¶å¤¹ç®¡ç†')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)

        Button('æ–°å»ºæ–‡ä»¶å¤¹')
          .fontSize(14)
          .backgroundColor('#1890ff')
          .onClick(() => {
            this.showCreateDialog = true
          })
      }
      .width('100%')
      .padding(16)
      .justifyContent(FlexAlign.SpaceBetween)

      Divider()

      // æ–‡ä»¶å¤¹åˆ—è¡¨
      List() {
        // æœªåˆ†ç±»é¡¹
        ListItem() {
          Row() {
            Image($r('app.media.rss'))
              .width(20)
              .height(20)
              .margin({ right: 12 })

            Column() {
              Text('æœªåˆ†ç±»')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
              Text('æœªå½’ç±»çš„è®¢é˜…æº')
                .fontSize(12)
                .fontColor('#666')
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Start)
            .flexGrow(1)

            Text('ç‚¹å‡»æŸ¥çœ‹')
              .fontSize(12)
              .fontColor('#999')
          }
          .width('100%')
          .padding(12)
          .backgroundColor(this.selectedFolderId === null ? '#f0f0f0' : '#fff')
        }
        .onClick(() => {
          this.loadFeedsInFolder(null)
        })

        // æ–‡ä»¶å¤¹åˆ—è¡¨
        ForEach(this.folders, (folder: RSSFolder) => {
          ListItem() {
            Row() {
              // æ–‡ä»¶å¤¹å›¾æ ‡
              Text('ðŸ“')
                .fontSize(20)
                .margin({ right: 12 })

              Column() {
                Text(folder.name)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                
                Text(`${folder.feedCount} ä¸ªè®¢é˜…æº`)
                  .fontSize(12)
                  .fontColor('#666')
                  .margin({ top: 2 })
              }
              .alignItems(HorizontalAlign.Start)
              .flexGrow(1)

              Column() {
                if (folder.unreadCount > 0) {
                  Text(folder.unreadCount.toString())
                    .fontSize(12)
                    .fontColor('#fff')
                    .backgroundColor('#ff4d4f')
                    .borderRadius(10)
                    .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                }
              }
            }
            .width('100%')
            .padding(12)
            .backgroundColor(this.selectedFolderId === folder.id ? '#f0f0f0' : '#fff')
          }
          .onClick(() => {
            this.loadFeedsInFolder(folder.id)
          })
        }, (folder: RSSFolder) => folder.id)
      }
      .divider({ strokeWidth: 1, color: '#f0f0f0' })
      .flexGrow(1)

      // é€‰ä¸­æ–‡ä»¶å¤¹çš„å†…å®¹
      if (this.selectedFolderId !== null || this.feedsInFolder.length > 0) {
        Divider()
        
        Column() {
          Text(this.selectedFolderId === null ? 'æœªåˆ†ç±»è®¢é˜…æº' : 'æ–‡ä»¶å¤¹å†…å®¹')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 8 })

          if (this.feedsInFolder.length === 0) {
            Text('æš‚æ— è®¢é˜…æº')
              .fontSize(14)
              .fontColor('#999')
              .textAlign(TextAlign.Center)
          } else {
            List() {
              ForEach(this.feedsInFolder, (feed: RSSFeed) => {
                ListItem() {
                  Row() {
                    Image(feed.favicon)
                      .width(20)
                      .height(20)
                      .margin({ right: 8 })

                    Column() {
                      Text(feed.title)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                      Text(feed.description)
                        .fontSize(12)
                        .fontColor('#666')
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                    }
                    .alignItems(HorizontalAlign.Start)
                    .flexGrow(1)

                    if (feed.unreadCount > 0) {
                      Text(feed.unreadCount.toString())
                        .fontSize(12)
                        .fontColor('#fff')
                        .backgroundColor('#1890ff')
                        .borderRadius(10)
                        .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                    }
                  }
                  .width('100%')
                  .padding(8)
                }
              }, (feed: RSSFeed) => feed.id)
            }
            .height(200)
          }
        }
        .padding(16)
        .alignItems(HorizontalAlign.Start)
      }
    }
    .height('100%')
    .backgroundColor('#fff')
    .bindSheet($$this.showCreateDialog, this.CreateFolderDialog(), {
      height: 300,
      dragBar: true
    })
  }

  @Builder CreateFolderDialog() {
    Column() {
      Text('åˆ›å»ºæ–°æ–‡ä»¶å¤¹')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 20 })

      TextInput({ placeholder: 'æ–‡ä»¶å¤¹åç§°' })
        .onChange((value: string) => {
          this.newFolderName = value
        })
        .margin({ bottom: 12 })

      TextInput({ placeholder: 'æ–‡ä»¶å¤¹æè¿°ï¼ˆå¯é€‰ï¼‰' })
        .onChange((value: string) => {
          this.newFolderDescription = value
        })
        .margin({ bottom: 12 })

      Row() {
        Text('é¢œè‰²:')
          .fontSize(14)
          .margin({ right: 8 })

        ForEach(['#1890ff', '#52c41a', '#faad14', '#f5222d', '#722ed1'], (color: string) => {
          Button()
            .width(20)
            .height(20)
            .backgroundColor(color)
            .margin({ right: 8 })
            .borderRadius(10)
            .border({ width: this.newFolderColor === color ? 2 : 0, color: '#000' })
            .onClick(() => {
              this.newFolderColor = color
            })
        })
      }
      .margin({ bottom: 20 })

      Row() {
        Button('å–æ¶ˆ')
          .flexGrow(1)
          .backgroundColor('#f0f0f0')
          .fontColor('#000')
          .margin({ right: 8 })
          .onClick(() => {
            this.showCreateDialog = false
          })

        Button('åˆ›å»º')
          .flexGrow(1)
          .backgroundColor('#1890ff')
          .onClick(() => {
            this.createFolder()
          })
      }
    }
    .padding(20)
    .alignItems(HorizontalAlign.Start)
  }
} 